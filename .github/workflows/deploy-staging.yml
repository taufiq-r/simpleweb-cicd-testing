name: deploy-staging

on:
  push:
    branches: [ 'develop' ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_REGISTRY: ghcr.io
      IMAGE_OWNER: ${{ github.repository_owner }}
      REPO_NAME: ${{ github.event.repository.name }}
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Set images tags
        shell: bash
        run: |
          echo "FRONTEND_IMAGE = ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.REPO_NAME }}-frontend:latest" >> $GITHUB_ENV
          echo "BACKEND_IMAGE= ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.REPO_NAME }}-backend:latest" >> $GITHUB_ENV
      - name: Build & push images
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          file: ./frontend/Dockerfile
          tags: ${{ env.FRONTEND_IMAGE }}
          cache-from: type=gha

      - name: Build backend and push
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.BACKEND_IMAGE }}

      - name: Deploy to staging server via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.STAGE_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            # Example: pull images and restart stack (swap with your orchestration commands)
            docker pull ${{ env.FRONTEND_IMAGE }}
            docker pull ${{ env.BACKEND_IMAGE }}
            # If using docker stack
            if [ -f ~/deploy/docker-stack.yml ]; then
              docker stack deploy -c ~/deploy/docker-stack.yml app_staging || true
            fi

      - name: Post deploy notification to Discord (success)
        if: success()
        uses: ./.github/actions/discord-notify
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: "Staging Deployed: ${{ github.repository }}"
          body: "Staging URL: ${{ secrets.STAGE_APP_URL }}"

      - name: Post deploy notification to Discord (failure)
        if: failure()
        uses: ./.github/actions/discord-notify
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: "Staging Deploy Failed: ${{ github.repository }}"
          body: "Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
