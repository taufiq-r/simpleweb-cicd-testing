name: deploy-production

on:
  push:
    branches: [ 'main', 'master' ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: [self-hosted, linux, prod] #ubuntu-latest
    env:
      IMAGE_REGISTRY: ghcr.io
      IMAGE_OWNER: ${{ github.repository_owner }}
      REPO_NAME: ${{ github.event.repository.name }}
      
    steps:
      - uses: actions/checkout@v4

      - name: login GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set images tags
        shell: bash
        run: |
          echo "FRONTEND_IMAGE=${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.REPO_NAME }}-frontend:latest" >> $GITHUB_ENV
          echo "BACKEND_IMAGE=${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.REPO_NAME }}-backend:latest" >> $GITHUB_ENV

      - name: Build & push images
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          file: ./frontend/Dockerfile
          tags: ${{ env.FRONTEND_IMAGE }}

      - name: Build backend and push
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.BACKEND_IMAGE }}

      - name: Deploy to production server via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            docker pull ${{ env.FRONTEND_IMAGE }}
            docker pull ${{ env.BACKEND_IMAGE }}
            if [ -f ~/deploy/docker-stack.yml ]; then
              docker stack deploy -c ~/deploy/docker-stack.yml app_prod || true
            fi

      - name: Post deploy notification to Discord (success)
        if: success()
        uses: ./.github/actions/discord-notify
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: "Production Deployed: ${{ github.repository }}"
          body: "Production URL: ${{ secrets.PROD_APP_URL }}"

      - name: Post deploy notification to Discord (failure)
        if: failure()
        uses: ./.github/actions/discord-notify
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: "Production Deploy Failed: ${{ github.repository }}"
          body: "Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
