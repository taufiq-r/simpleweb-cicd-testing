version: '3.8'
services:
  postgres:
    image: postgres:17
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: app
      POSTGRES_PASSWORD: changeme
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - appnet

  pgbouncer:
    image: edoburu/pgbouncer
    volumes:
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro
    environment:
      - DATABASE_URL=postgres://app:changeme@postgres:5432/appdb
    ports:
      - 6432:6432
    networks:
      - appnet

  backend:
    build: ./backend
    depends_on:
      - pgbouncer
    environment:
      DATABASE_URL: postgres://app:changeme@pgbouncer:6432/appdb
    networks:
      - appnet

  frontend:
    build: ./frontend
    ports:
      - 3000:80
    networks:
      - appnet

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - 8000:80
    depends_on:
      - frontend
      - backend
    networks:
      - appnet

volumes:
  pgdata:

networks:
  appnet:
    driver: bridge
